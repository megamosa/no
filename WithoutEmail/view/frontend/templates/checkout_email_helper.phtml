<script>
require([
    'jquery',
    'domReady!'
], function($) {
    'use strict';
    
    $(function() {
        // 1. وظيفة لإخفاء حقل البريد الإلكتروني
        function hideEmailField() {
            // إخفاء العنصر بواسطة CSS
            $('#customer-email-fieldset, .checkout-shipping-address [data-bind*="email"]').css({
                'position': 'absolute',
                'opacity': '0',
                'height': '1px',
                'width': '1px',
                'overflow': 'hidden',
                'clip': 'rect(0 0 0 0)',
                'margin': '-1px',
                'padding': '0',
                'border': '0',
                'z-index': '-1'
            });
            
            // ضمان أن يكون حقل البريد موجودًا للتحقق من الصحة
            $('#customer-email').attr('data-hidden-email', 'true');
            
            return true;
        }
        
        // 2. وظيفة لتوليد البريد الإلكتروني من الهاتف
        function setupPhoneToEmailUpdater() {
            // البحث عن حقل الهاتف
            var $phoneField = $('input[name="telephone"]');
            
            if ($phoneField.length) {
                // تسجيل حدث تغيير لحقل الهاتف
                $phoneField.off('input.magoarab change.magoarab keyup.magoarab');
                $phoneField.on('input.magoarab change.magoarab keyup.magoarab', function() {
                    var phoneValue = $(this).val();
                    
                    if (phoneValue && phoneValue.length > 0) {
                        // توليد البريد الإلكتروني
                        var domain = window.location.hostname;
                        var email = phoneValue + '@' + domain;
                        
                        // تحديث جميع حقول البريد الإلكتروني المحتملة
                        $('#customer-email, input[type="email"], input[name="username"]').each(function() {
                            var $emailField = $(this);
                            $emailField.val(email).trigger('change').trigger('keyup').trigger('blur');
                            
                            // تحديث كائن knockout إذا كان موجودًا
                            if (typeof ko !== 'undefined') {
                                try {
                                    var viewModel = ko.dataFor(this);
                                    if (viewModel && viewModel.email && typeof viewModel.email === 'function') {
                                        viewModel.email(email);
                                    }
                                } catch (e) {
                                    console.log('KO update error', e);
                                }
                            }
                        });
                    }
                });
                
                // تشغيل التحديث مباشرة إذا كان الحقل يحتوي على قيمة
                if ($phoneField.val() && $phoneField.val().length > 0) {
                    $phoneField.trigger('change.magoarab');
                }
                
                return true;
            }
            
            return false;
        }
        
        // 3. إعداد مراقب DOM
        function setupDomObserver() {
            var observer = new MutationObserver(function(mutations) {
                var shouldUpdateFields = false;
                
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes && mutation.addedNodes.length > 0) {
                        // التحقق مما إذا كانت العناصر المضافة تتضمن حقول الاهتمام
                        if ($(mutation.target).find('input[name="telephone"], #customer-email').length > 0) {
                            shouldUpdateFields = true;
                        }
                    }
                });
                
                if (shouldUpdateFields) {
                    hideEmailField();
                    setupPhoneToEmailUpdater();
                }
            });
            
            // بدء المراقبة على جميع DOM
            observer.observe(document.body, { 
                childList: true, 
                subtree: true 
            });
            
            return observer;
        }
        
        // تنفيذ الوظائف الرئيسية
        hideEmailField();
        setupPhoneToEmailUpdater();
        setupDomObserver();
        
        // تنفيذ متكرر للتأكد من الإخفاء والتوليد
        var checkInterval = setInterval(function() {
            hideEmailField();
            setupPhoneToEmailUpdater();
        }, 1000);
        
        // إيقاف التنفيذ المتكرر بعد 30 ثانية
        setTimeout(function() {
            clearInterval(checkInterval);
        }, 30000);
        
        // الاستماع لأحداث عملية الدفع
        $(document).on('contentUpdated checkout:afterSectionUpdate checkout:afterLoad', function() {
            hideEmailField();
            setupPhoneToEmailUpdater();
        });
    });
});
</script>
<style>
/* إخفاء حقل البريد الإلكتروني */
#customer-email-fieldset .field.required > .label,
#customer-email-fieldset .field-tooltip,
#customer-email-fieldset .note,
div[data-bind*="customer-email"] .label,
div[data-bind*="customer-email"] .note {
    display: none !important;
}

#customer-email-fieldset .field.required,
div[data-bind*="customer-email"] {
    position: absolute !important;
    opacity: 0 !important;
    height: 1px !important;
    width: 1px !important;
    overflow: hidden !important;
    clip: rect(0 0 0 0) !important;
    margin: -1px !important;
    padding: 0 !important;
    border: 0 !important;
    z-index: -1 !important;
}

/* تحسين ظهور حقل الهاتف */
input[name="telephone"] {
    font-weight: bold !important;
    font-size: 1.1em !important;
    border-color: #1979c3 !important;
    background-color: #f8f8f8 !important;
}

label[for*="telephone"] {
    font-weight: bold !important;
    font-size: 1.1em !important;
    color: #1979c3 !important;
}
</style>